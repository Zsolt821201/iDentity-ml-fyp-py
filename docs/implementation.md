
# Implementation

# Frameworks/Languages

Python
Javascript

Django
OpenCV

## Using Django

To use Django, you need to install Python and Django.

## Create a new Django project

Create a new Django project: Once Django is installed, you can create a new project by running the following command:

```bash
django-admin startproject identity_website
```

Replace project_name with the name of your project. This command will create a new directory with the same name as your project, which will contain the basic files and folders needed to start a new Django project.

Create a new Django app: A Django project is made up of one or more apps. An app is a module that contains models, views, templates, and other code that serves a specific purpose. You can create a new app by running the following command:

```bash
python manage.py startapp identity
```

Replace app_name with the name of your app. This command will create a new directory with the same name as your app, which will contain the basic files and folders needed to start a new Django app.

## Linking the App to the Website

To link the app to the website, add the app to the `INSTALLED_APPS` list in the `settings.py` file.

```python
INSTALLED_APPS = [
    'identity.apps.IdentityConfig',
]
```

## The Models

Django will implement the database using the definitions in the `models.py` file.  The developer never has to write SQL code.  The `models.py` file is where you define the data structures for your application.  Each class in `models.py` represents a table in the database.  Each attribute of the class represents a column in the table.  The following code defines a Location class that represents a table in the database.

eg.

  ```python
  from django.db import models
  
  
  class Location(models.Model):
      id = models.AutoField(primary_key=True)
      address = models.CharField(max_length=200)
      description = models.CharField(max_length=200)
      email = models.EmailField(max_length=200, unique=True)
      name = models.CharField(max_length=200, unique=True)
      telephone = models.CharField(max_length=20)
  
      def __str__(self):
          return self.name
  ```
  
  creates a Table in the database
  
  ```sql
  CREATE TABLE "identity_location" 
  ("id" integer NOT NULL PRIMARY KEY AUTOINCREMENT,
   "address" varchar(200) NOT NULL,
   "description" varchar(200) NOT NULL,
   "email" varchar(200) NOT NULL UNIQUE, "name" varchar(200) NOT NULL UNIQUE, "telephone" varchar(20) NOT NULL)
  ```

### Migrations

To create the database perform these migrations. Note `0001` increments with each migration. A second migration would be `0002` and so on.

```bash
python manage.py makemigrations identity
python manage.py sqlmigrate identity 0001
python manage.py migrate
```

```bash
python manage.py migrate
```

### Overriding the default User Model

In Django, user accounts are represented with a built-in User model. The Identity App requires custom fields for its User model not present in django.contrib.auth.User.
To override the default User model:

1. Create a new model, in this example, named UserAccount that inherits from AbstractBaseUser classes. This new model will be used instead django.contrib.auth.User.
2. Add any additional fields you require to the new model UserAccount.
3. When referencing the UserAccount Model, use settings.AUTH_USER_MODEL rather than UserAccount
class Roster(models.Model):
    id = models.AutoField(primary_key=True)
    #...#
    user_account = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
    )
4. Then set the AUTH_USER_MODEL setting in the Website App settings.py file to point to your new User model UserAccount with its namespace.
AUTH_USER_MODEL = 'identity.UserAccount'

## The Views

`views.py` is where you define the functions used when a user visits a particular URL. Each function in views.py acts as a controller in a traditional MVC application by connected the model with the views for your application. Views can use templates to render the HTML that is returned to the user (c.f. [The Templates](#the-templates)).  Views can also return JSON data to be used by a JavaScript application.

### The Templates

Html files are stored in a project folder called `templates`. The templates folder must be located in the same directory as the `views.py` file.

For example, the following code defines a function called `index` that returns a rendered template `website/index.html` relative to the templates folder.

```python
def index(request):
    return render(request, 'website/index.html')
```

### The Static Files

Static files are files that are not generated by the application.  For example, images, CSS files, and JavaScript files are static files.  Static files are stored in a project folder called `static`.  The static folder must be located in the same directory as the `views.py` file. To reference a static file in a template, use the `static` tag.

```html
{% load static %}
<!--...-->
<img src="{% static 'img/identity-logo.png' %}" alt="Identity Logo"/>
<!--...-->
```

### Passing Data to Templates (The Context)

The context is a dictionary that contains the data that is passed to the template.  The context is passed to the render function as the third parameter.

The named parameters in the context are then available in the template as variables.  For example, the following code defines a function called `setup_facial_recognition` that returns a rendered template from `user-accounts/setup-facial-recognition.html` relative to the templates folder.

`views.py`

```python
def setup_facial_recognition(request):
    user_account = get_object_or_404(UserAccount, pk=request.user.id)
    context = { 'user_account_id': user_account.id }
    return render(request, 'user-accounts/setup-facial-recognition.html', context)
```

*user-accounts/setup-facial-recognition.html*

```django
{% extends "master.html" %}
{% load static %}
{% block content %}
    <div class="column">
        <h2>User Facial Recognition Setup</h2>
        <p>Please look directly at the camera until your face is detected and profile recorded.</p>
        <video id="videoInput" width="320" height="240">
        </video>
        <p id="errorMessage" class="error"></p>
        <input type="hidden"
               id="user-account-id"
               name="user-account-id"
               value="{{ user_account_id }}"/>
        <button id="startButton"
                class="btn btn-primary"
                onClick="setupUserFacialRecognition()">
            Setup User Facial Recognition
        </button>
        <p id="statusMessage"></p>
    </div>
{% endblock content %}
{% block scripts %}
    <script src="{% static "js/facial-login.js" %}"></script>
    <script type="text/javascript">startCamera(VideoResolutionFormatNames.QVGA, 'videoInput');</script>
{% endblock scripts %}
```

### Extending templates

A base template is a template that other templates extend. Generally they contain the HTML that is common to all pages in your application with named blocks that other templates can override with view specific content. This allows you to avoid duplicating the same HTML in multiple templates.  For example, a base template might contain the HTML for the header, footer, and navigation bar. Then other templates can then extend the base template and add their own HTML content for the named blocks.

For example, the following code blocks defines a base template called master.html with a title block and login.html extends the base template and overrides the title block.

master.html

```django
<html lang="en">
    <head>
        <title>Identity
            {% block title %}
            {% endblock title %}
        </title>
    </head>
    <body></body>
</html>
```

login.html

```django
{% extends 'identity/master.html' %}
{% block title %}Login{% endblock title %}
```

Only the content between the block tags is needed to create view. The rest of the HTML is inherited from the base template.

### Handling 404 Errors

The `get_object_or_404` function is used to return a 404 error if the object is not found.  For example, the following code defines a function called `user_account` that returns a rendered template from `user-accounts/user-account.html` relative to the templates folder. If the user account is not found, a 404 error is returned.

```python
def location_details(request, location_id):
    location = get_object_or_404(Location, pk=location_id)
    # ...
```

### Securing the Views

Security for an app is assisted by decorators.  The `@login_required` decorator is used to ensure that a user is logged in before a function is called.  The `@permission_required` decorator is used to ensure that a user has a particular permission before a function is called.  The `@csrf_exempt` decorator is used to allow a function to be called from a POST request.

If a user is not logged in, the `@login_required` decorator will redirect the user to the login page.  If a user does not have the required permission, the `@permission_required` decorator will return a 403 error and appropriately redirect the user.

```python
from django.contrib.auth.decorators import login_required, permission_required

@login_required
@permission_required('identity.activate_sign_in', raise_exception=True)
def sign_in(request, location_id):
    location = get_object_or_404(Location, pk=location_id)
    return render(request, 'user-accounts/sign-in-new.html', {'location': location})
```

### Securing blocks of the Templates

To secure blocks of the templates, use the `if` tag. The `if` tag with `user.is_authenticated` function can be used to check if a user is authenticated.  In the example below The `if` tag is used to display the appropriate navigation bar links if a user is authenticated. If a user is not authenticated, the login link is displayed.

```html
{% if user.is_authenticated %}
    <li class="nav-item"><a class="nav-link" href="{% url 'locations' %}">Locations</a></li>
    <!--...-->
    <li class="nav-item"><a class="nav-link" href="{% url 'logout' %}">Logout</a></li>
{% else %}
    <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Login</a></li>
{% endif %}
```

The `if` tag with `perms.identity.activate_sign_in` function can be used to check if a user has a particular permission.  In the example below, the `if` tag is used to display the Activate Sign in button if the user has the `identity.activate_sign_in` permission.

```html
<td><p id="my-desc">Actions</p></td>
<td>
    {% if perms.identity.activate_sign_in %}
        <a class="btn btn-primary" href="{% url 'sign_in' location.id %}">Activate Sign in</a>
    {% endif %}
</td>
```

## The Urls

In the identity project, the urls.py file is located in the identity folder.  The urls.py file maps the URL to the functions defined in views.py. The `path` function is used to map the URL to the function.  The `name` parameter is used to reference the URL in templates.  
Take the following example:

```python
from django.urls import path
from .import views
from .views import UserEditView, PasswordsChangeView

urlpatterns = [
    # ...
    path('', views.index, name='index'),
    path('edit-user-profile/', UserEditView.as_view(), name="edit-user-profile"),
    path('locations/', views.locations, name='locations'),
    path('locations/<int:location_id>/',views.location_details, name='details'),
    # ...
]
```

`path('locations/', views.locations, name='locations'),`

The URL is then accessed as follows: <http://localhost:8000/locations>

URl parameters are defined using angle brackets e.g. `<int:location_id>`.  The `int` parameter defines the type of the parameter.  The `location_id` parameter is the name of the parameter.  The parameter is then available in the function as a parameter e.g. `def location_details(request, location_id):`.  The URL is then defined as follows:

`path('locations/<int:location_id>/',views.location_details, name='details')`

The URL is then accessed as follows: <http://localhost:8000/locations/1/>

Generic views are used to map the URL to the function by using the `as_view` function e.g. `path('edit-user-profile/', UserEditView.as_view(), name="edit-user-profile"),`

The URL is then accessed as follows: <http://localhost:8000/edit-user-profile>

### Referencing the URLs

Referencing the URL in templates is done using the `url` function e.g.

master.html

```django
<a class="nav-link" href="{% url 'locations' %}">Locations</a>
```

### Adding the project URLs to the Website

To add the URLs from the identity app to the website app, the following code `path('', include('identity.urls'))` is added to the website project urls.py file. `''` indicates that the URLs are added to the root of the website.

```python
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('identity.urls')),
]
```

## The Admin

The admin site is a default Django application that provides a simple interface to manage content on the site.  The admin site is located at `/admin`.  The admin site is used to manage the database tables and the users.

admin.py

Custom Forms are used to add additional fields to the admin site.  The custom forms are defined in the `admin.py` file.  The custom forms are used in the following files:

## The Forms

crispy forms are used to style the forms.  The crispy forms are defined in forms.py.  The crispy forms are used in the following files:

In the settings.py file, the crispy forms are added to the installed apps.

```python
INSTALLED_APPS = [
    # ...
    'crispy_forms',
]
```

## The Website

## User Login

In the settings.py to set the login URL and the login redirect URL, add the following code.

```python
LOGIN_URL = '/login/'
LOGIN_REDIRECT_URL = '/login/'
```

## Using Open CV /Utilities

I placed the Application Code for Image Processing in utilities.py

haarcascades are pre-trained classifiers that are used to detect objects in images.
The identity project used `haarcascade_frontalface_default.xml` to detect faces in images.

## Constants and File Paths

Constants for FilePaths and application Settings are defined at the top of the `utilities.py` file.

```python
PARENT_DIRECTORY: Path = Path(__file__).resolve().parent.parent
CLASSIFIER_CONFIGURATION: str = str(
    PARENT_DIRECTORY / 'haarcascade_frontalface_default.xml')
DATABASE_DIRECTORY: str = str(PARENT_DIRECTORY / 'database/')
DATABASE_FACE_DIRECTORY: str = str(
    PARENT_DIRECTORY / 'database/identity_face_dataset')
DATABASE_LOG_DIRECTORY: str = str(
    PARENT_DIRECTORY / 'database/log')
DATABASE_FACIAL_TRAINER: str = str(PARENT_DIRECTORY / 'database/trainer.yml')
FACE_CONFIDENCE_LEVEL:float = 80.0
```

`FACE_CONFIDENCE_LEVEL` is the maximum confidence level acceptable that a face can be considered a match.  The lower the value the more confident the application is that the face is a identified correctly. File paths are defined relative to the `utilities.py` file for teh directories that are used by the application, such as the `database` directory, the `database/identity_face_dataset` directory, and the `database/trainer.yml` file.

## Face Detection

The [OpenCv](https://opencv.org/) library is used to detect faces in images and to train the application to identify faces.

### How to use Open CV

The opencv-python package is a Python wrapper for the OpenCV library.  This package must be installed to use opencv in the application. c.f. 6.4 To install and Run the project.

Import the package using the following code in python files.

```python
import cv2
```

#### How to find a face in an image

Given a gray-scale image Mat object as input the function `detect_user_face` returns a tuple containing a boolean flag and a numpy array.  The flag is True if a face is detected in the image and False if no face is detected.  The numpy array contains the coordinates of the face in the image.

[detect_user_face](https://github.com/Zsolt821201/iDentity-ml-fyp-py/blob/25b7eaa48465b378fb8faf3ed1d705b32a05e284/identity-django/identity/utilities.py)

```python
def detect_user_face(gray_scale_image, min_size=None) -> tuple[bool,ndarray]:
    face_detector_classifier = cv2.CascadeClassifier(CLASSIFIER_CONFIGURATION)
    faces: ndarray = face_detector_classifier.detectMultiScale(
        gray_scale_image, scaleFactor=1.3, minNeighbors=5, minSize=min_size)

    if len(faces) == 0:
        print("Error: No face detected")
        return False, None

    if len(faces) > 1:
        print("Error: More than one face detected")
        return False, None

    return True, faces[0]
```

`face_detector_classifier = cv2.CascadeClassifier(CLASSIFIER_CONFIGURATION)` loads the classifier configuration file into the face_detector_classifier object.  The `detectMultiScale` method of the face_detector_classifier object is used to detect faces in the image.  The `detectMultiScale` method returns a numpy array of faces. The `detect_user_face` function checks for the cases of (1) no face detected and (2) more than one face detected.  If either of these cases occur, the function returns False and None.  If a single face is detected, the function returns True and the coordinates of the face in the image.

`detect_and_save_user_face`

```python
def detect_and_save_user_face(user_account_id, image, image_number):
    """Detects a single face in the image and saves it to the database"""
    gray_scale_image = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)

    face_found, face = detect_user_face(gray_scale_image)
    if face_found:
        x, y, w, h = face
        directory: str = f"{DATABASE_FACE_DIRECTORY}/user-{user_account_id}"
        os.makedirs(directory, exist_ok=True)
        cv2.imwrite(f"{directory}/{image_number}.jpg",
                    gray_scale_image[y:y+h, x:x+w])

    return face_found
```

The `detect_and_save_user_face` function takes a user account id, an image, and an image number as input.  The function converts the image to a gray-scale image and calls the `detect_user_face` function to detect a face in the image.  If a face is detected, the function saves the face to the database directory.  The function returns a boolean flag indicating whether a face was detected.

#### How to train the model

The `face_training` function trains the model using the images in the `DATABASE_FACE_DIRECTORY` directory.  The function saves the trained model to the `DATABASE_FACIAL_TRAINER` file. `recognizer = cv2.face.LBPHFaceRecognizer_create()` creates a face recognizer object.  The `recognizer.train` method takes the list of images and the list of user ids as input and trains the model. With the model trained `recognizer.write` method saves the trained model to the `DATABASE_FACIAL_TRAINER` file.

```python
def face_training():
    faces, face_ids = get_images_and_labels(DATABASE_FACE_DIRECTORY)

    recognizer = cv2.face.LBPHFaceRecognizer_create()
    recognizer.train(faces, numpy.array(face_ids))

    # Ensure the database directory exists before saving the model
    os.makedirs(DATABASE_DIRECTORY, exist_ok=True)
    # Save the model into trainer/trainer.yml
    recognizer.write(DATABASE_FACIAL_TRAINER)
```

The function `get_images_and_labels` returns a tuple of lists (1) a list of images of the users faces from the directory `DATABASE_FACE_DIRECTORY` and (2) a list of user ids.  The structure of the directory is users ids as subdirectories that contain 30 images of the users face

```python
def get_images_and_labels(path) -> tuple[list, list]:
    face_ids: list[str] = []
    face_samples: list[ndarray] = []

    user_directories = [os.path.join(path, directory)
                        for directory in os.listdir(path)]
    for user_directory in user_directories:
        user_image_files = [os.path.join(
            user_directory, file) for file in os.listdir(user_directory)]
        face_id = int(os.path.split(user_directory)[-1].split("-")[1])

        for image_path in user_image_files:
            face_image_numpy: ndarray = numpy.array(
                Image.open(image_path), 'uint8')
            face_samples.append(face_image_numpy)
            face_ids.append(face_id)

    return face_samples, face_ids
```

#### How to recognize a face in an image

```python
def face_image_recognition(recognizer: cv2.face.LBPHFaceRecognizer, image, min_size = None):
    gray_scale_image = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)

    is_face_present, face = detect_user_face(gray_scale_image, min_size=min_size)
    
    if(not is_face_present):
        return None, 0, None
    
    x, y, width, height = face
    user_id, confidence = recognizer.predict(gray_scale_image[y:y+height, x:x+width])
        
    return user_id, confidence, face
```

```python
def face_recognition_web(open_cv_image: ndarray):
    recognizer:cv2.face.LBPHFaceRecognizer = cv2.face.LBPHFaceRecognizer_create()
    recognizer.read(DATABASE_FACIAL_TRAINER)

    user_id, confidence, face = face_image_recognition(recognizer,  open_cv_image)

    return user_id, confidence
```

### File Encoding


### Creating Sample users

For demonstration purposes, sample users were created using Youtube videos.  The following code creates a sample user taking a video from Youtube.

```python
def build_sample_user(video_path:str, session_user_account_id:str):
    
    video_capture = cv2.VideoCapture(video_path)
    face_detector_classifier = cv2.CascadeClassifier(CLASSIFIER_CONFIGURATION)

    image_number: int = 0
    FACE_SAMPLE_COUNT=30
    ESCAPE_KEY: int = 27
    while(image_number < FACE_SAMPLE_COUNT):
        is_video_capture_open, open_cv_image = video_capture.read()

        if not is_video_capture_open:
            print("Error: Camera is not opened")
            break

        cv2.imshow('image', open_cv_image)

        gray_scale_image = cv2.cvtColor(open_cv_image, cv2.COLOR_BGR2GRAY)

        faces: ndarray = face_detector_classifier.detectMultiScale(
            gray_scale_image, 1.3, 5)

        face_found = detect_and_save_user_face(
            session_user_account_id, open_cv_image, image_number)
        if face_found:
            image_number += 1

        

        for (x, y, w, h) in faces:
            cv2.rectangle(open_cv_image, (x, y), (x+w, y+h), (255, 0, 0), 2)
            cv2.imshow('image', open_cv_image)

        if cv2.waitKey(1) == ESCAPE_KEY:
            break
    # Do a bit of cleanup
    video_capture.release()
    cv2.destroyAllWindows()
```

## Unit Testing

### How to run the unit tests
